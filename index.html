<html>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>æ‰‹æœºç¼–ç¨‹</title>
    <body>
    <style>
      * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
}

body {
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    transition: background-color 0.3s, color 0.3s;
    overflow-x: hidden;
}

.app-container {
    display: flex;
    height: 100vh;
    overflow: hidden;
    position: relative;
}

/* èœå•æŒ‰é’® */
.menu-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    z-index: 1001;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: none;
}

/* ä¾§è¾¹æ æ ·å¼ - æ”¹ä¸ºä¾§æ‹‰æ¡† */
.sidebar {
    width: 320px;
    background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
    color: #ecf0f1;
    padding: 25px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    z-index: 1000;
    position: relative;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.15);
}

.sidebar-header h1 {
    font-size: 1.6rem;
    font-weight: 600;
}

.new-chapter-btn {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 14px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s;
    min-height: 50px;
}

.new-chapter-btn:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
}

/* æ ‡ç­¾é¡µæ ·å¼ */
.sidebar-tabs {
    display: flex;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 8px;
    gap: 6px;
}

.tab-btn {
    flex: 1;
    padding: 16px 20px;
    background: none;
    border: none;
    color: #bdc3c7;
    cursor: pointer;
    border-radius: 10px;
    transition: all 0.3s;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 500;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tab-btn.active {
    background: #3498db;
    color: white;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    transform: scale(1.02);
}

.tab-content {
    flex-grow: 1;
    overflow-y: auto;
}

.chapters-list, .history-list, .materials-list {
    display: none;
}

.chapters-list.active, .history-list.active, .materials-list.active {
    display: block;
}

/* ç« èŠ‚å’Œå†å²ç‰ˆæœ¬é¡¹æ ·å¼ */
.chapter-item, .history-item {
    padding: 20px 25px;
    margin-bottom: 12px;
    background-color: rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 5px solid transparent;
    min-height: 80px;
}

.chapter-item:hover, .history-item:hover {
    background-color: rgba(255, 255, 255, 0.18);
    transform: translateX(8px);
}

.chapter-item.active, .history-item.active {
    background-color: rgba(52, 152, 219, 0.35);
    border-left-color: #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.chapter-title, .history-title {
    font-weight: 600;
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 1.1rem;
    margin-right: 15px;
}

.history-info {
    font-size: 0.9rem;
    color: #bdc3c7;
    margin-top: 6px;
    opacity: 0.9;
}

.chapter-actions, .history-actions {
    display: flex;
    gap: 12px;
}

.chapter-action, .history-action {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #ecf0f1;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.3s;
    padding: 10px 16px;
    border-radius: 8px;
    min-width: 60px;
    text-align: center;
}

.chapter-action:hover, .history-action:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

/* ä¸»ç¼–è¾‘åŒºæ ·å¼ */
.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: white;
    transition: background-color 0.3s;
    position: relative;
}

.editor-header {
    padding: 20px 30px;
    border-bottom: 2px solid #eaeaea;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color 0.3s;
}

.chapter-input {
    font-size: 1.6rem;
    font-weight: 700;
    border: none;
    outline: none;
    width: 70%;
    color: #2c3e50;
    background: transparent;
    transition: color 0.3s;
    padding: 10px 0;
}

.editor-toolbar {
    display: flex;
    gap: 12px;
}

.toolbar-btn {
    background: none;
    border: none;
    padding: 12px 18px;
    border-radius: 8px;
    cursor: pointer;
    color: #7f8c8d;
    transition: all 0.3s;
    font-size: 1rem;
    font-weight: 500;
    min-height: 50px;
}

.toolbar-btn:hover {
    background-color: #f0f0f0;
    color: #2c3e50;
    transform: translateY(-2px);
}

.editor-content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.editor-textarea {
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    resize: none;
    font-size: 1.2rem;
    line-height: 1.8;
    color: #2c3e50;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    background: transparent;
    transition: color 0.3s;
}

/* çŠ¶æ€æ æ ·å¼ */
.status-bar {
    padding: 15px 30px;
    background-color: #ecf0f1;
    border-top: 2px solid #dde4e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    color: #7f8c8d;
    transition: all 0.3s;
}

.word-count {
    font-weight: 600;
    font-size: 1.1rem;
}

/* é®ç½©å±‚ */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.overlay.active {
    display: block;
}

/* ç‰ˆæœ¬æ¯”è¾ƒæ¨¡æ€æ¡† */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 900px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 25px 30px;
    border-bottom: 2px solid #eaeaea;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.modal-header h2 {
    font-size: 1.8rem;
    color: #2c3e50;
}

.modal-body {
    padding: 25px 30px;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    gap: 25px;
}

.version-comparison {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.version-comparison h3 {
    font-size: 1.3rem;
    color: #2c3e50;
    margin-bottom: 10px;
}

.version-content {
    border: 2px solid #eaeaea;
    border-radius: 8px;
    padding: 20px;
    height: 350px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    background: #fafafa;
}

.modal-footer {
    padding: 20px 30px;
    border-top: 2px solid #eaeaea;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: #f8f9fa;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
    font-weight: 500;
    min-height: 50px;
    min-width: 120px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
}

/* ç‰ˆæœ¬æ¯”è¾ƒé¢œè‰²æ ‡è®° */
.added-char {
    background-color: #90EE90;
    color: #006400;
    padding: 1px 2px;
    border-radius: 2px;
    font-weight: bold;
}

.deleted-char {
    background-color: #FFB6C1;
    color: #8B0000;
    padding: 1px 2px;
    border-radius: 2px;
    text-decoration: line-through;
    font-weight: bold;
}

.modified-char {
    background-color: #FFD700;
    color: #8B4513;
    padding: 1px 2px;
    border-radius: 2px;
    font-weight: bold;
}

.diff-line {
    margin: 2px 0;
    line-height: 1.4;
}

/* ç¬¬äºŒç¼–è¾‘å™¨æ ·å¼ */
.second-editor {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    height: 100vh;
    background: white;
    transition: right 0.3s ease;
    z-index: 900;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
}

.second-editor.active {
    right: 0;
}

/* ç´ æåˆ†ç±»æ ·å¼ */
.material-categories {
    padding: 20px;
    height: 100%;
    overflow-y: auto;
}

.material-category {
    margin-bottom: 30px;
}

.material-category h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #3498db;
    font-size: 1.2rem;
}

.materials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.material-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.material-item:hover {
    background: #e3f2fd;
    border-color: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
}

.material-item.active {
    background: #3498db;
    color: white;
    border-color: #2980b9;
}

.material-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.material-name {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 5px;
    flex: 1;
}

.material-type {
    font-size: 0.8rem;
    color: #6c757d;
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 10px;
}

.material-item.active .material-type {
    background: rgba(255,255,255,0.3);
    color: white;
}

.material-content {
    font-size: 0.9rem;
    line-height: 1.4;
    color: #495057;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.material-item.active .material-content {
    color: rgba(255,255,255,0.9);
}

.material-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    margin-top: 8px;
}

.material-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s;
}

.material-item:hover .material-actions {
    opacity: 1;
}

.material-action {
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
}

/* å¤åˆ¶åŠŸèƒ½åŠ¨ç”» */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.copy-notification {
    animation: slideIn 0.3s ease;
}

/* å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯ä¾§æ‹‰æ¡† */
@media (max-width: 768px) {
    .menu-toggle {
        display: block;
    }
    
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        transform: translateX(-100%);
        box-shadow: 2px 0 20px rgba(0,0,0,0.3);
        width: 85%;
        max-width: 320px;
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .editor-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        padding: 15px 20px;
    }
    
    .chapter-input {
        width: 100%;
        font-size: 1.4rem;
    }
    
    .editor-toolbar {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .toolbar-btn {
        flex: 1;
        padding: 10px 8px;
        font-size: 0.9rem;
        min-height: 45px;
        margin: 2px;
    }
    
    .modal-body {
        flex-direction: column;
        padding: 20px;
    }
    
    .version-content {
        height: 250px;
    }
    
    .second-editor {
        width: 100%;
    }
    
    .materials-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
    }
}

@media (min-width: 769px) {
    .second-editor {
        width: 45%;
        max-width: 600px;
    }
}

/* æš—è‰²ä¸»é¢˜ */
.dark-theme {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

.dark-theme .editor-container {
    background-color: #2d2d2d;
}

.dark-theme .editor-header {
    border-bottom-color: #444;
}

.dark-theme .chapter-input {
    color: #e0e0e0;
}

.dark-theme .editor-textarea {
    color: #e0e0e0;
}

.dark-theme .status-bar {
    background-color: #252525;
    border-top-color: #444;
    color: #aaa;
}

.dark-theme .toolbar-btn:hover {
    background-color: #444;
    color: #e0e0e0;
}

.dark-theme .modal-content {
    background: #2d2d2d;
    color: #e0e0e0;
}

.dark-theme .modal-header {
    background: #333;
    border-color: #444;
}

.dark-theme .modal-header h2 {
    color: #e0e0e0;
}

.dark-theme .modal-footer {
    background: #333;
    border-color: #444;
}

.dark-theme .version-content {
    border-color: #444;
    background: #1a1a1a;
    color: #e0e0e0;
}

.dark-theme .version-comparison h3 {
    color: #e0e0e0;
}

/* æš—è‰²ä¸»é¢˜ä¸‹çš„é¢œè‰²æ ‡è®° */
.dark-theme .added-char {
    background-color: #2E8B57;
    color: #98FB98;
}

.dark-theme .deleted-char {
    background-color: #8B0000;
    color: #FFB6C1;
}

.dark-theme .modified-char {
    background-color: #B8860B;
    color: #FFD700;
}

.version-content {
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

/* æš—è‰²ä¸»é¢˜ç¬¬äºŒç¼–è¾‘å™¨ */
.dark-theme .second-editor {
    background: #2d2d2d;
}

.dark-theme .material-item {
    background: #3d3d3d;
    border-color: #444;
    color: #e0e0e0;
}

.dark-theme .material-item:hover {
    background: #4a4a4a;
    border-color: #3498db;
}

.dark-theme .material-content {
    color: #b0b0b0;
}

.dark-theme .material-type {
    background: #555;
    color: #ccc;
}

.dark-theme .material-category h3 {
    color: #e0e0e0;
    border-bottom-color: #3498db;
}

/* ç©ºçŠ¶æ€æç¤º */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
    font-size: 1.1rem;
}

/* å…³é—­ä¾§è¾¹æ æŒ‰é’® */
.close-sidebar {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: #ecf0f1;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
}

@media (max-width: 768px) {
    .close-sidebar {
        display: block;
    }
}

/* æ»‘åŠ¨æŒ‡ç¤ºå™¨ */
.swipe-indicator {
    position: fixed;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    background: rgba(52, 152, 219, 0.8);
    color: white;
    padding: 10px 5px;
    border-radius: 20px;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    z-index: 800;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s;
}

.swipe-indicator:hover {
    background: #3498db;
    transform: translateY(-50%) scale(1.1);
}
/* éœ€è¦æ·»åŠ è¿™äº›é€‰æ‹©å™¨ */
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; }
.form-group input, .form-group select, .form-group textarea { 
    width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
}
</style>
<body>
    <!-- èœå•æŒ‰é’® -->
    <button class="menu-toggle" id="menuToggle">ğŸ“š ç« èŠ‚</button>
    
    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>
    
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <button class="close-sidebar" id="closeSidebar">Ã—</button>
            <div class="sidebar-header">
                <h1>å°è¯´å†™ä½œåŠ©æ‰‹</h1>
                <button class="new-chapter-btn" id="newChapterBtn">æ–°å»ºç« èŠ‚</button>
            </div>
            
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="chapters">ç« èŠ‚</button>
                <button class="tab-btn" data-tab="materials">ç´ æåº“</button>
                <button class="tab-btn" data-tab="history">å†å²ç‰ˆæœ¬</button>
            </div>
            
            <div class="tab-content">
                <div class="chapters-list active" id="chaptersList">
                    <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="materials-list" id="materialsList">
                    <!-- ç´ æåº“ç®¡ç†ç•Œé¢ -->
                    <div class="materials-toolbar">
                        <button class="toolbar-btn" id="uploadMaterialBtn">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
                        <button class="toolbar-btn" id="createMaterialBtn">âœï¸ æ–°å»ºç´ æ</button>
                    </div>
                    <div class="materials-stats">
                        <div>æ€»ç´ æ: <span id="totalMaterials">0</span></div>
                        <div>å›¾ç‰‡: <span id="imageCount">0</span></div>
                        <div>æ–‡æ¡£: <span id="docCount">0</span></div>
                    </div>
                </div>
                
                <div class="history-list" id="historyList">
                    <!-- å†å²ç‰ˆæœ¬åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ä¸»ç¼–è¾‘åŒº -->
        <div class="editor-container" id="mainEditor">
            <div class="editor-header">
                <input type="text" class="chapter-input" id="chapterTitle" placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜">
                <div class="editor-toolbar">
                    <button class="toolbar-btn" id="themeToggle">ğŸŒ™ æš—è‰²æ¨¡å¼</button>
                    <button class="toolbar-btn" id="saveVersionBtn">ğŸ’¾ ä¿å­˜ç‰ˆæœ¬</button>
                    <button class="toolbar-btn" id="copyAllBtn">ğŸ“‹ å¤åˆ¶å…¨æ–‡</button>
                    <button class="toolbar-btn" id="exportBtn">ğŸ“¤ å¯¼å‡ºå°è¯´</button>
                    <button class="toolbar-btn" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
                    <button class="toolbar-btn" id="toggleSecondEditor">ğŸ“– èµ„æ–™åŒº</button>
                </div>
            </div>
            
            <div class="editor-content">
                <textarea class="editor-textarea" id="editor" placeholder="å¼€å§‹ä½ çš„åˆ›ä½œä¹‹æ—…..."></textarea>
            </div>
            
            <div class="status-bar">
                <div class="auto-save">ğŸ’¾ è‡ªåŠ¨ä¿å­˜å·²å¼€å¯</div>
                <div class="word-count">ğŸ“ å­—æ•°: <span id="wordCount">0</span></div>
            </div>
        </div>
        
        <!-- ç¬¬äºŒç¼–è¾‘å™¨ï¼ˆèµ„æ–™åŒºï¼‰ -->
        <div class="editor-container second-editor" id="secondEditor">
            <div class="editor-header">
                <input type="text" class="chapter-input" id="materialSearch" placeholder="ğŸ” æœç´¢ç´ æ...">
                <div class="editor-toolbar">
                    <button class="toolbar-btn" id="addMaterialBtn">â• æ·»åŠ ç´ æ</button>
                    <button class="toolbar-btn" id="toggleMainEditor">âœï¸ è¿”å›å†™ä½œ</button>
                </div>
            </div>
            
            <div class="editor-content">
                <div class="material-categories">
                    <div class="material-category">
                        <h3>ğŸ‘¥ è§’è‰²è®¾å®š</h3>
                        <div class="materials-grid" id="charactersGrid">
                            <!-- è§’è‰²ç´ æå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <h3>ğŸ° åœ°ç‚¹åœºæ™¯</h3>
                        <div class="materials-grid" id="locationsGrid">
                            <!-- åœ°ç‚¹ç´ æå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <h3>âš”ï¸ ç‰©å“é“å…·</h3>
                        <div class="materials-grid" id="itemsGrid">
                            <!-- ç‰©å“ç´ æå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <h3>ğŸ“– æƒ…èŠ‚å¤§çº²</h3>
                        <div class="materials-grid" id="plotsGrid">
                            <!-- æƒ…èŠ‚ç´ æå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <h3>ğŸ“„ æ–‡æ¡£èµ„æ–™</h3>
                        <div class="materials-grid" id="documentsGrid">
                            <!-- æ–‡æ¡£ç´ æå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="material-category">
                        <h3>ğŸ–¼ï¸ å›¾ç‰‡ç´ æ</h3>
                        <div class="materials-grid" id="imagesGrid">
                            <!-- å›¾ç‰‡ç´ æå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="material-info">ğŸ“š ç´ æåº“</div>
                <div class="material-count">ğŸ“¦ ç´ æ: <span id="materialCount">0</span> ä¸ª</div>
            </div>
        </div>
    </div>

    <!-- ç‰ˆæœ¬æ¯”è¾ƒæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="compareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç‰ˆæœ¬æ¯”è¾ƒ</h2>
                <button class="toolbar-btn" id="closeModal">å…³é—­</button>
            </div>
            <div class="modal-body">
                <div class="version-comparison">
                    <h3>å½“å‰ç‰ˆæœ¬</h3>
                    <div class="version-content" id="currentVersionContent"></div>
                </div>
                <div class="version-comparison">
                    <h3>å†å²ç‰ˆæœ¬</h3>
                    <div class="version-content" id="historyVersionContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRestore">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmRestore">æ¢å¤æ­¤ç‰ˆæœ¬</button>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨å¤åˆ¶æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="manualCopyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ è¯·å¤åˆ¶ä»¥ä¸‹å†…å®¹</h2>
                <button class="toolbar-btn" id="closeCopyModal">å…³é—­</button>
            </div>
            <div class="modal-body">
                <textarea class="version-content" id="manualCopyText" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="selectCopyText()">å…¨é€‰æ–‡æœ¬</button>
                <button class="btn btn-primary" onclick="copySelectedText()">å¤åˆ¶é€‰ä¸­å†…å®¹</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç´ ææ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="addMaterialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ·»åŠ ç´ æ</h2>
                <button class="toolbar-btn" id="closeMaterialModal">å…³é—­</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç´ æç±»å‹:</label>
                    <select id="materialType">
                        <option value="characters">è§’è‰²è®¾å®š</option>
                        <option value="locations">åœ°ç‚¹åœºæ™¯</option>
                        <option value="items">ç‰©å“é“å…·</option>
                        <option value="plots">æƒ…èŠ‚å¤§çº²</option>
                        <option value="documents">æ–‡æ¡£èµ„æ–™</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç´ æåç§°:</label>
                    <input type="text" id="materialName" placeholder="è¯·è¾“å…¥ç´ æåç§°">
                </div>
                <div class="form-group">
                    <label>ç´ æå†…å®¹:</label>
                    <textarea id="materialContent" placeholder="è¯·è¾“å…¥ç´ ææè¿°å†…å®¹..." rows="6"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡:</label>
                    <input type="file" id="materialImage" accept="image/*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelMaterial">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveMaterial">ä¿å­˜ç´ æ</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" id="materialFileInput" multiple accept=".txt,.md,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp" style="display: none;">


<script>
// åº”ç”¨çŠ¶æ€
const state = {
    chapters: JSON.parse(localStorage.getItem('novelChapters')) || [
        { id: 1, title: 'ç¬¬ä¸€ç«  å¼€ç«¯', content: '' }
    ],
    currentChapterId: 1,
    isDarkTheme: localStorage.getItem('darkTheme') === 'true',
    versions: JSON.parse(localStorage.getItem('novelVersions')) || {},
    selectedVersion: null,
    isSidebarOpen: false
};

// ç´ æåº“æ•°æ®
const materialLibrary = {
    characters: JSON.parse(localStorage.getItem('novelMaterials_characters')) || [],
    locations: JSON.parse(localStorage.getItem('novelMaterials_locations')) || [],
    items: JSON.parse(localStorage.getItem('novelMaterials_items')) || [],
    plots: JSON.parse(localStorage.getItem('novelMaterials_plots')) || [],
    documents: JSON.parse(localStorage.getItem('novelMaterials_documents')) || [],
    images: JSON.parse(localStorage.getItem('novelMaterials_images')) || []
};

// DOMå…ƒç´ 
const elements = {
    menuToggle: document.getElementById('menuToggle'),
    overlay: document.getElementById('overlay'),
    sidebar: document.getElementById('sidebar'),
    closeSidebar: document.getElementById('closeSidebar'),
    chaptersList: document.getElementById('chaptersList'),
    historyList: document.getElementById('historyList'),
    materialsList: document.getElementById('materialsList'),
    chapterTitle: document.getElementById('chapterTitle'),
    editor: document.getElementById('editor'),
    wordCount: document.getElementById('wordCount'),
    newChapterBtn: document.getElementById('newChapterBtn'),
    themeToggle: document.getElementById('themeToggle'),
    exportBtn: document.getElementById('exportBtn'),
    saveBtn: document.getElementById('saveBtn'),
    saveVersionBtn: document.getElementById('saveVersionBtn'),
    copyAllBtn: document.getElementById('copyAllBtn'),
    toggleSecondEditor: document.getElementById('toggleSecondEditor'),
    toggleMainEditor: document.getElementById('toggleMainEditor'),
    compareModal: document.getElementById('compareModal'),
    currentVersionContent: document.getElementById('currentVersionContent'),
    historyVersionContent: document.getElementById('historyVersionContent'),
    closeModal: document.getElementById('closeModal'),
    cancelRestore: document.getElementById('cancelRestore'),
    confirmRestore: document.getElementById('confirmRestore'),
    secondEditor: document.getElementById('secondEditor'),
    materialSearch: document.getElementById('materialSearch'),
    addMaterialBtn: document.getElementById('addMaterialBtn'),
    materialFileInput: document.getElementById('materialFileInput'),
    uploadMaterialBtn: document.getElementById('uploadMaterialBtn'),
    createMaterialBtn: document.getElementById('createMaterialBtn'),
    materialCount: document.getElementById('materialCount'),
    manualCopyModal: document.getElementById('manualCopyModal'),
    manualCopyText: document.getElementById('manualCopyText'),
    addMaterialModal: document.getElementById('addMaterialModal'),
    closeCopyModal: document.getElementById('closeCopyModal'),
    closeMaterialModal: document.getElementById('closeMaterialModal'),
    cancelMaterial: document.getElementById('cancelMaterial'),
    saveMaterial: document.getElementById('saveMaterial')
};

// åŸºç¡€å·¥å…·å‡½æ•°
function calculateWordCount(text) {
    const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
    const otherWords = text.replace(/[\u4e00-\u9fa5]/g, '').trim().split(/\s+/).filter(word => word.length > 0);
    return chineseChars.length + otherWords.length;
}

function formatDate(timestamp) {
    const date = new Date(timestamp);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ç« èŠ‚ç®¡ç†å‡½æ•°
function updateWordCount() {
    const text = elements.editor.value;
    elements.wordCount.textContent = calculateWordCount(text);
}

function loadChapter(chapterId) {
    const chapter = state.chapters.find(c => c.id === chapterId);
    if (chapter) {
        state.currentChapterId = chapterId;
        elements.chapterTitle.value = chapter.title || '';
        elements.editor.value = chapter.content || '';
        updateWordCount();
        renderChaptersList();
    }
}

function saveCurrentChapter() {
    const chapterIndex = state.chapters.findIndex(c => c.id === state.currentChapterId);
    if (chapterIndex !== -1) {
        state.chapters[chapterIndex].title = elements.chapterTitle.value;
        state.chapters[chapterIndex].content = elements.editor.value;
        localStorage.setItem('novelChapters', JSON.stringify(state.chapters));
    }
}

function createNewChapter() {
    const newId = state.chapters.length > 0 ? 
        Math.max(...state.chapters.map(c => c.id)) + 1 : 1;
    
    const newChapter = {
        id: newId,
        title: `ç¬¬${state.chapters.length + 1}ç«  æ–°ç« èŠ‚`,
        content: ''
    };
    
    state.chapters.push(newChapter);
    saveCurrentChapter();
    loadChapter(newId);
    
    if (window.innerWidth <= 768) {
        closeSidebar();
    }
}

function deleteChapter(chapterId) {
    if (state.chapters.length <= 1) {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç« èŠ‚');
        return;
    }
    
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        state.chapters = state.chapters.filter(c => c.id !== chapterId);
        
        if (state.currentChapterId === chapterId) {
            loadChapter(state.chapters[0].id);
        }
        
        localStorage.setItem('novelChapters', JSON.stringify(state.chapters));
        renderChaptersList();
    }
}

function renderChaptersList() {
    elements.chaptersList.innerHTML = '';
    
    if (state.chapters.length === 0) {
        elements.chaptersList.innerHTML = '<div class="empty-state">æš‚æ— ç« èŠ‚ï¼Œç‚¹å‡»"æ–°å»ºç« èŠ‚"å¼€å§‹åˆ›ä½œ</div>';
        return;
    }
    
    state.chapters.forEach(chapter => {
        const chapterElement = document.createElement('div');
        chapterElement.className = `chapter-item ${chapter.id === state.currentChapterId ? 'active' : ''}`;
        chapterElement.innerHTML = `
            <div>
                <div class="chapter-title">${chapter.title || 'æœªå‘½åç« èŠ‚'}</div>
            </div>
            <div class="chapter-actions">
                <button class="chapter-action" data-id="${chapter.id}">åˆ é™¤</button>
            </div>
        `;
        
        chapterElement.addEventListener('click', (e) => {
            if (!e.target.classList.contains('chapter-action')) {
                if (chapter.id !== state.currentChapterId) {
                    saveCurrentChapter();
                    loadChapter(chapter.id);
                }
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            }
        });
        
        const deleteBtn = chapterElement.querySelector('.chapter-action');
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteChapter(chapter.id);
        });
        
        elements.chaptersList.appendChild(chapterElement);
    });
}

// ç‰ˆæœ¬ç®¡ç†å‡½æ•°
function saveVersion() {
    const chapter = state.chapters.find(c => c.id === state.currentChapterId);
    if (!chapter) return;
    
    if (!state.versions[state.currentChapterId]) {
        state.versions[state.currentChapterId] = [];
    }
    
    const versions = state.versions[state.currentChapterId];
    const newVersionId = versions.length > 0 ? Math.max(...versions.map(v => v.id)) + 1 : 1;
    
    const newVersion = {
        id: newVersionId,
        timestamp: new Date().toISOString(),
        title: chapter.title,
        content: JSON.parse(JSON.stringify(chapter.content)),
        wordCount: calculateWordCount(chapter.content),
        type: 'manual'
    };
    
    versions.push(newVersion);
    
    if (versions.length > 50) {
        versions.shift();
    }
    
    localStorage.setItem('novelVersions', JSON.stringify(state.versions));
    
    if (document.querySelector('.tab-btn[data-tab="history"]').classList.contains('active')) {
        renderHistoryList();
    }

    const originalText = elements.saveVersionBtn.textContent;
    elements.saveVersionBtn.textContent = 'âœ… å·²ä¿å­˜';
    setTimeout(() => {
        elements.saveVersionBtn.textContent = originalText;
    }, 1000);
}

let lastAutoSaveTime = 0;
function autoSaveVersion() {
    const chapter = state.chapters.find(c => c.id === state.currentChapterId);
    if (!chapter || !chapter.content || chapter.content.trim().length < 10) return;
    
    const now = Date.now();
    if (now - lastAutoSaveTime > 300000) {
        if (!state.versions[state.currentChapterId]) {
            state.versions[state.currentChapterId] = [];
        }
        
        const versions = state.versions[state.currentChapterId];
        const newVersionId = versions.length > 0 ? Math.max(...versions.map(v => v.id)) + 1 : 1;
        
        const newVersion = {
            id: newVersionId,
            timestamp: new Date().toISOString(),
            title: chapter.title,
            content: JSON.parse(JSON.stringify(chapter.content)),
            wordCount: calculateWordCount(chapter.content),
            type: 'auto'
        };
        
        versions.push(newVersion);
        
        if (versions.length > 50) {
            versions.shift();
        }
        
        localStorage.setItem('novelVersions', JSON.stringify(state.versions));
        lastAutoSaveTime = now;
    }
}

function renderHistoryList() {
    elements.historyList.innerHTML = '';
    
    const chapterVersions = state.versions[state.currentChapterId] || [];
    
    if (chapterVersions.length === 0) {
        elements.historyList.innerHTML = '<div class="empty-state">æš‚æ— å†å²ç‰ˆæœ¬</div>';
        return;
    }
    
    chapterVersions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    chapterVersions.forEach((version, index) => {
        const versionElement = document.createElement('div');
        versionElement.className = 'history-item';
        versionElement.innerHTML = `
            <div>
                <div class="history-title">ç‰ˆæœ¬ ${chapterVersions.length - index} 
                    <span style="font-size:0.7rem; color:${version.type === 'manual' ? '#3498db' : '#95a5a6'}; margin-left:8px;">
                        ${version.type === 'manual' ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}
                    </span>
                </div>
                <div class="history-info">
                    ${formatDate(version.timestamp)} Â· ${version.wordCount} å­—
                </div>
            </div>
            <div class="history-actions">
                <button class="history-action compare-btn" data-id="${version.id}">æ¯”è¾ƒ</button>
                <button class="history-action restore-btn" data-id="${version.id}">æ¢å¤</button>
            </div>
        `;
        
        const compareBtn = versionElement.querySelector('.compare-btn');
        compareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            compareVersion(version.id);
        });
        
        const restoreBtn = versionElement.querySelector('.restore-btn');
        restoreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            restoreVersion(version.id);
        });
        
        elements.historyList.appendChild(versionElement);
    });
}

function compareVersion(versionId) {
    const versions = state.versions[state.currentChapterId] || [];
    const version = versions.find(v => v.id === versionId);
    const currentChapter = state.chapters.find(c => c.id === state.currentChapterId);
    
    if (!version || !currentChapter) return;
    
    state.selectedVersion = versionId;
    
    const currentContent = currentChapter.content;
    const historyContent = version.content;
    
    elements.currentVersionContent.textContent = currentContent;
    elements.historyVersionContent.textContent = historyContent;
    
    elements.compareModal.classList.add('active');
}

function restoreVersion(versionId) {
    const versions = state.versions[state.currentChapterId] || [];
    const version = versions.find(v => v.id === versionId);
    
    if (!version) return;
    
    if (confirm(`ç¡®å®šè¦æ¢å¤åˆ°è¿™ä¸ªç‰ˆæœ¬å—ï¼Ÿå½“å‰å†…å®¹å°†è¢«æ›¿æ¢ã€‚`)) {
        const chapterIndex = state.chapters.findIndex(c => c.id === state.currentChapterId);
        if (chapterIndex !== -1) {
            state.chapters[chapterIndex].content = JSON.parse(JSON.stringify(version.content));
            localStorage.setItem('novelChapters', JSON.stringify(state.chapters));
            loadChapter(state.currentChapterId);
            closeModal();
        }
    }
}

// ä¸»é¢˜å’Œå¯¼å‡ºå‡½æ•°
function toggleTheme() {
    state.isDarkTheme = !state.isDarkTheme;
    document.body.classList.toggle('dark-theme');
    elements.themeToggle.textContent = state.isDarkTheme ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ æš—è‰²æ¨¡å¼';
    localStorage.setItem('darkTheme', state.isDarkTheme);
}

function exportNovel() {
    if (state.chapters.length === 0) {
        alert('æ²¡æœ‰å†…å®¹å¯å¯¼å‡º');
        return;
    }
    
    let content = '';
    
    state.chapters.forEach(chapter => {
        content += `# ${chapter.title}\n\n`;
        content += `${chapter.content}\n\n`;
        content += '---\n\n';
    });
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'æˆ‘çš„å°è¯´.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ä¾§è¾¹æ å‡½æ•°
function toggleSidebar() {
    state.isSidebarOpen = !state.isSidebarOpen;
    elements.sidebar.classList.toggle('active', state.isSidebarOpen);
    elements.overlay.classList.toggle('active', state.isSidebarOpen);
}

function closeSidebar() {
    state.isSidebarOpen = false;
    elements.sidebar.classList.remove('active');
    elements.overlay.classList.remove('active');
}

function closeModal() {
    elements.compareModal.classList.remove('active');
    state.selectedVersion = null;
}

function confirmRestore() {
    if (state.selectedVersion) {
        restoreVersion(state.selectedVersion);
    }
}

// æ ‡ç­¾é¡µåˆ‡æ¢
function setupTabSwitching() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.tab-content > div').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'List').classList.add('active');
            
            if (tabName === 'history') {
                renderHistoryList();
            }
        });
    });
}

// äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
function setupEventListeners() {
    elements.newChapterBtn.addEventListener('click', createNewChapter);
    elements.themeToggle.addEventListener('click', toggleTheme);
    elements.exportBtn.addEventListener('click', exportNovel);
    elements.saveBtn.addEventListener('click', saveCurrentChapter);
    elements.saveVersionBtn.addEventListener('click', saveVersion);
    elements.copyAllBtn.addEventListener('click', () => FullTextCopy.copyFullText());
    elements.editor.addEventListener('input', updateWordCount);
    elements.closeModal.addEventListener('click', closeModal);
    elements.cancelRestore.addEventListener('click', closeModal);
    elements.confirmRestore.addEventListener('click', confirmRestore);
    
    elements.menuToggle.addEventListener('click', toggleSidebar);
    elements.overlay.addEventListener('click', closeSidebar);
    elements.closeSidebar.addEventListener('click', closeSidebar);
    
    elements.toggleSecondEditor.addEventListener('click', () => SecondEditor.show());
    elements.toggleMainEditor.addEventListener('click', () => SecondEditor.hide());
    
    // ç´ æåº“äº‹ä»¶ - ç¡®ä¿è¿™äº›äº‹ä»¶æ­£ç¡®ç»‘å®š
    elements.addMaterialBtn.addEventListener('click', () => SecondEditor.showAddMaterialModal());
    elements.createMaterialBtn.addEventListener('click', () => SecondEditor.showAddMaterialModal());
    elements.uploadMaterialBtn.addEventListener('click', () => {
        console.log('ä¸Šä¼ æŒ‰é’®ç‚¹å‡»'); // è°ƒè¯•ç”¨
        elements.materialFileInput.click();
    });
    
    elements.materialFileInput.addEventListener('change', (e) => {
        console.log('æ–‡ä»¶é€‰æ‹©å˜åŒ–', e.target.files); // è°ƒè¯•ç”¨
        SecondEditor.handleFileUpload(e.target.files);
    });
    
    elements.materialSearch.addEventListener('input', (e) => SecondEditor.searchMaterials(e.target.value));
    
    // æ·»åŠ ç´ ææ¨¡æ€æ¡†äº‹ä»¶
    elements.saveMaterial.addEventListener('click', () => {
        console.log('ä¿å­˜ç´ ææŒ‰é’®ç‚¹å‡»'); // è°ƒè¯•ç”¨
        SecondEditor.saveMaterialFromForm();
    });
    
    // ç¡®ä¿å›¾ç‰‡ä¸Šä¼ è¾“å…¥æ­£ç¡®ç»‘å®š
    const materialImageInput = document.getElementById('materialImage');
    if (materialImageInput) {
        materialImageInput.addEventListener('change', (e) => {
            console.log('å›¾ç‰‡æ–‡ä»¶é€‰æ‹©', e.target.files); // è°ƒè¯•ç”¨
            SecondEditor.handleImageUpload(e);
        });
    }
    
    // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
    elements.closeCopyModal.addEventListener('click', () => {
        elements.manualCopyModal.classList.remove('active');
    });
    
    elements.closeMaterialModal.addEventListener('click', () => {
        SecondEditor.closeAddMaterialModal();
    });
    
    elements.cancelMaterial.addEventListener('click', () => {
        SecondEditor.closeAddMaterialModal();
    });
}

// ç¬¬äºŒç¼–è¾‘å™¨// ç¬¬äºŒç¼–è¾‘å™¨
const SecondEditor = {
    isActive: false,
    currentImageFile: null,
    
    init() {
        this.renderMaterialCategories();
        this.updateMaterialStats();
    },
    
    show() {
        elements.secondEditor.classList.add('active');
        this.isActive = true;
        this.updateMaterialStats();
    },
    
    hide() {
        elements.secondEditor.classList.remove('active');
        this.isActive = false;
    },
    
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
            this.currentImageFile = file;
        }
    },
    
    // ä»è¡¨å•ä¿å­˜ç´ æ
    saveMaterialFromForm() {
        const type = document.getElementById('materialType').value;
        const name = document.getElementById('materialName').value;
        const content = document.getElementById('materialContent').value;
        
        if (!name.trim()) {
            alert('è¯·è¾“å…¥ç´ æåç§°');
            return;
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        if (this.currentImageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.addMaterial(type, name, content, e.target.result);
                this.closeAddMaterialModal();
            };
            reader.readAsDataURL(this.currentImageFile);
        } else {
            this.addMaterial(type, name, content);
            this.closeAddMaterialModal();
        }
    },
    
    // å…³é—­æ·»åŠ ç´ ææ¨¡æ€æ¡†
    closeAddMaterialModal() {
        elements.addMaterialModal.classList.remove('active');
        document.getElementById('materialName').value = '';
        document.getElementById('materialContent').value = '';
        document.getElementById('materialImage').value = '';
        this.currentImageFile = null;
    },
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    async handleFileUpload(files) {
        for (let file of files) {
            await this.processFile(file);
        }
        elements.materialFileInput.value = '';
        this.updateMaterialStats();
    },
    
    // å¤„ç†å•ä¸ªæ–‡ä»¶
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
async handleFileUpload(files) {
    console.log('å¼€å§‹å¤„ç†æ–‡ä»¶ä¸Šä¼ ', files); // è°ƒè¯•ç”¨
    
    if (!files || files.length === 0) {
        console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    for (let file of files) {
        console.log('å¤„ç†æ–‡ä»¶:', file.name, file.type); // è°ƒè¯•ç”¨
        await this.processFile(file);
    }
    
    elements.materialFileInput.value = '';
    this.updateMaterialStats();
    this.renderMaterialCategories(); // é‡æ–°æ¸²æŸ“ç´ æåˆ—è¡¨
    
    console.log('æ–‡ä»¶ä¸Šä¼ å®Œæˆ'); // è°ƒè¯•ç”¨
},

// å¤„ç†å•ä¸ªæ–‡ä»¶
async processFile(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        
        console.log('å¤„ç†æ–‡ä»¶ç±»å‹:', file.type, 'æ–‡ä»¶å:', file.name); // è°ƒè¯•ç”¨
        
        if (file.type.startsWith('image/')) {
            // å¤„ç†å›¾ç‰‡æ–‡ä»¶
            reader.onload = (e) => {
                console.log('å›¾ç‰‡æ–‡ä»¶è¯»å–å®Œæˆ'); // è°ƒè¯•ç”¨
                this.addMaterial(
                    'images',
                    file.name,
                    `å›¾ç‰‡ç´ æ: ${file.name}`,
                    e.target.result
                );
                resolve();
            };
            reader.onerror = () => {
                console.error('å›¾ç‰‡æ–‡ä»¶è¯»å–å¤±è´¥');
                resolve();
            };
            reader.readAsDataURL(file);
        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            // å¤„ç†æ–‡æœ¬æ–‡ä»¶
            reader.onload = (e) => {
                console.log('æ–‡æœ¬æ–‡ä»¶è¯»å–å®Œæˆ'); // è°ƒè¯•ç”¨
                this.addMaterial(
                    'documents',
                    file.name.replace('.txt', ''),
                    e.target.result,
                    null
                );
                resolve();
            };
            reader.onerror = () => {
                console.error('æ–‡æœ¬æ–‡ä»¶è¯»å–å¤±è´¥');
                resolve();
            };
            reader.readAsText(file);
        } else {
            // å¤„ç†å…¶ä»–æ–‡æ¡£
            console.log('å¤„ç†å…¶ä»–ç±»å‹æ–‡ä»¶'); // è°ƒè¯•ç”¨
            this.addMaterial(
                'documents',
                file.name,
                `æ–‡æ¡£æ–‡ä»¶: ${file.name} (${file.type})`,
                null
            );
            resolve();
        }
    });
},
    
    // æ›´æ–°ç´ æç»Ÿè®¡
    updateMaterialStats() {
        let total = 0;
        let imageCount = 0;
        let docCount = 0;
        
        for (const category in materialLibrary) {
            total += materialLibrary[category].length;
            if (category === 'images') imageCount = materialLibrary[category].length;
            if (category === 'documents') docCount = materialLibrary[category].length;
        }
        
        elements.materialCount.textContent = total;
        // æ›´æ–°ç´ æç»Ÿè®¡æ˜¾ç¤º
        const totalMaterialsEl = document.getElementById('totalMaterials');
        const imageCountEl = document.getElementById('imageCount');
        const docCountEl = document.getElementById('docCount');
        
        if (totalMaterialsEl) totalMaterialsEl.textContent = total;
        if (imageCountEl) imageCountEl.textContent = imageCount;
        if (docCountEl) docCountEl.textContent = docCount;
    },
    
    // æ˜¾ç¤ºæ·»åŠ ç´ ææ¨¡æ€æ¡†
    showAddMaterialModal() {
        elements.addMaterialModal.classList.add('active');
    },
    
    // æ¸²æŸ“ç´ æåˆ†ç±»
    renderMaterialCategories() {
        const categories = ['characters', 'locations', 'items', 'plots', 'documents', 'images'];
        
        categories.forEach(category => {
            const grid = document.getElementById(`${category}Grid`);
            if (grid) {
                grid.innerHTML = this.renderMaterialsByCategory(category);
                
                grid.querySelectorAll('.material-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('material-action')) {
                            this.useMaterial(item.dataset.id);
                        }
                    });
                });
            }
        });
    },
    
    // æ¸²æŸ“æŒ‡å®šåˆ†ç±»çš„ç´ æ
    renderMaterialsByCategory(categoryId) {
        const materials = materialLibrary[categoryId] || [];
        
        if (materials.length === 0) {
            return '<div class="empty-state">æš‚æ— ç´ æ</div>';
        }
        
        return materials.map(material => `
            <div class="material-item" data-id="${material.id}">
                <div class="material-actions">
                    <button class="material-action" onclick="SecondEditor.useMaterial('${material.id}')">ğŸ“</button>
                    <button class="material-action" onclick="SecondEditor.deleteMaterial('${material.id}', '${categoryId}')">ğŸ—‘ï¸</button>
                </div>
                <div class="material-header">
                    <div class="material-name">${material.name}</div>
                    <div class="material-type">${this.getTypeLabel(material.type || categoryId)}</div>
                </div>
                <div class="material-content">
                    ${this.truncateContent(material.content || '')}
                </div>
                ${material.data && material.data.startsWith('data:image') ? 
                    `<img src="${material.data}" class="material-image" alt="${material.name}">` : ''}
            </div>
        `).join('');
    },
    
    // ä½¿ç”¨ç´ æï¼ˆæ’å…¥åˆ°ä¸»ç¼–è¾‘å™¨ï¼‰
    useMaterial(materialId) {
        const material = this.findMaterialById(materialId);
        if (!material) return;
        
        const mainEditor = elements.editor;
        const cursorPos = mainEditor.selectionStart;
        const textBefore = mainEditor.value.substring(0, cursorPos);
        const textAfter = mainEditor.value.substring(cursorPos);
        
        let insertText = '';
        
        if (material.data && material.data.startsWith('data:image')) {
            insertText = `[å›¾ç‰‡: ${material.name}]`;
        } else {
            insertText = `ã€${material.name}ã€‘${material.content}\n`;
        }
        
        mainEditor.value = textBefore + insertText + textAfter;
        mainEditor.focus();
        mainEditor.selectionStart = cursorPos + insertText.length;
        mainEditor.selectionEnd = cursorPos + insertText.length;
        
        this.hide();
        this.showNotification(`ç´ æ"${material.name}"å·²æ’å…¥`);
    },
    
    // æŸ¥æ‰¾ç´ æ
    findMaterialById(materialId) {
        for (const category in materialLibrary) {
            const material = materialLibrary[category].find(m => m.id == materialId);
            if (material) return material;
        }
        return null;
    },
    
    // åˆ é™¤ç´ æ
    deleteMaterial(materialId, categoryId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç´ æå—ï¼Ÿ')) return;
        
        materialLibrary[categoryId] = materialLibrary[categoryId].filter(m => m.id != materialId);
        this.saveMaterialLibrary();
        this.renderMaterialCategories();
        this.updateMaterialStats();
        
        this.showNotification('ç´ æå·²åˆ é™¤');
    },
    
    // æ·»åŠ ç´ æ
    addMaterial(category, name, content, data = null) {
        const material = {
            id: Date.now(),
            name: name,
            type: category,
            content: content || '',
            data: data,
            created: new Date().toISOString()
        };
        
        if (!materialLibrary[category]) {
            materialLibrary[category] = [];
        }
        
        materialLibrary[category].push(material);
        this.saveMaterialLibrary();
        this.renderMaterialCategories();
        this.updateMaterialStats();
        
        this.showNotification(`"${name}" å·²æ·»åŠ åˆ°ç´ æåº“`);
    },
    
    // æœç´¢ç´ æ
    searchMaterials(keyword) {
        if (!keyword.trim()) {
            this.renderMaterialCategories();
            return;
        }
        
        const categories = ['characters', 'locations', 'items', 'plots', 'documents', 'images'];
        
        categories.forEach(category => {
            const grid = document.getElementById(`${category}Grid`);
            const materials = materialLibrary[category] || [];
            
            const filtered = materials.filter(material => 
                material.name.includes(keyword) || 
                (material.content && material.content.includes(keyword))
            );
            
            if (grid) {
                if (filtered.length === 0) {
                    grid.innerHTML = '<div class="empty-state">æ— åŒ¹é…ç´ æ</div>';
                } else {
                    grid.innerHTML = filtered.map(material => `
                        <div class="material-item" data-id="${material.id}">
                            <div class="material-actions">
                                <button class="material-action" onclick="SecondEditor.useMaterial('${material.id}')">ğŸ“</button>
                                <button class="material-action" onclick="SecondEditor.deleteMaterial('${material.id}', '${category}')">ğŸ—‘ï¸</button>
                            </div>
                            <div class="material-header">
                                <div class="material-name">${material.name}</div>
                                <div class="material-type">${this.getTypeLabel(material.type || category)}</div>
                            </div>
                            <div class="material-content">
                                ${this.truncateContent(material.content || '')}
                            </div>
                        </div>
                    `).join('');
                }
            }
        });
    },
    
    // ä¿å­˜ç´ æåº“
    saveMaterialLibrary() {
        for (const category in materialLibrary) {
            localStorage.setItem(`novelMaterials_${category}`, JSON.stringify(materialLibrary[category]));
        }
    },
    
    // å…¶ä»–è¾…åŠ©æ–¹æ³•
    getTypeLabel(type) {
        const labels = {
            'characters': 'è§’è‰²',
            'locations': 'åœ°ç‚¹', 
            'items': 'ç‰©å“',
            'plots': 'æƒ…èŠ‚',
            'documents': 'æ–‡æ¡£',
            'images': 'å›¾ç‰‡'
        };
        return labels[type] || type;
    },
    
    truncateContent(content, length = 50) {
        if (!content) return 'æš‚æ— æè¿°';
        return content.length > length ? content.substring(0, length) + '...' : content;
    },
    
    showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; 
            background: #27ae60; color: white; padding: 10px 20px;
            border-radius: 5px; z-index: 10000;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 2000);
    }
};

// å…¨æ–‡å¤åˆ¶åŠŸèƒ½
const FullTextCopy = {
    init() {
        this.setupKeyboardShortcut();
    },
    
    setupKeyboardShortcut() {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                this.copyFullText();
            }
        });
    },
    
    generateFullText() {
        if (!state.chapters || state.chapters.length === 0) {
            return 'æš‚æ— å†…å®¹';
        }
        
        let fullText = '';
        
        const novelTitle = localStorage.getItem('novelTitle') || 'æˆ‘çš„å°è¯´';
        fullText += `ã€Š${novelTitle}ã€‹\n\n`;
        
        state.chapters.forEach((chapter, index) => {
            fullText += `ç¬¬${index + 1}ç«  ${chapter.title}\n\n`;
            fullText += `${chapter.content}\n\n`;
            
            if (index < state.chapters.length - 1) {
                fullText += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
            }
        });
        
        const totalWords = state.chapters.reduce((sum, chapter) => {
            return sum + calculateWordCount(chapter.content);
        }, 0);
        
        const totalChapters = state.chapters.length;
        const exportTime = new Date().toLocaleString('zh-CN');
        
        fullText += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
        fullText += `ç»Ÿè®¡ä¿¡æ¯ï¼š\n`;
        fullText += `æ€»ç« èŠ‚æ•°ï¼š${totalChapters}ç« \n`;
        fullText += `æ€»å­—æ•°ï¼š${totalWords}å­—\n`;
        fullText += `å¯¼å‡ºæ—¶é—´ï¼š${exportTime}\n`;
        
        return fullText;
    },
    
    async copyFullText() {
        try {
            const fullText = this.generateFullText();
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(fullText);
                this.showCopySuccess();
            } else {
                this.fallbackCopy(fullText);
            }
            
        } catch (error) {
            console.error('å¤åˆ¶å¤±è´¥:', error);
            this.showCopyError(fullText);
        }
    },
    
    fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (successful) {
                this.showCopySuccess();
            } else {
                this.showCopyError(text);
            }
        } catch (err) {
            document.body.removeChild(textArea);
            this.showCopyError(text);
        }
    },
    
    showCopySuccess() {
        const originalText = elements.copyAllBtn.innerHTML;
        elements.copyAllBtn.innerHTML = 'âœ… å·²å¤åˆ¶';
        elements.copyAllBtn.style.background = '#27ae60';
        
        setTimeout(() => {
            elements.copyAllBtn.innerHTML = originalText;
            elements.copyAllBtn.style.background = '';
        }, 2000);
    },
    
    showCopyError(text) {
        this.showTextForManualCopy(text);
    },
    
    showTextForManualCopy(text) {
        elements.manualCopyText.value = text;
        elements.manualCopyModal.classList.add('active');
        
        setTimeout(() => {
            elements.manualCopyText.select();
        }, 100);
    }
};

// æ‰‹åŠ¨å¤åˆ¶ç›¸å…³å‡½æ•°
function selectCopyText() {
    elements.manualCopyText.select();
}

function copySelectedText() {
    elements.manualCopyText.select();
    
    try {
        document.execCommand('copy');
        alert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        closeManualCopyModal();
    } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶æ–‡æœ¬');
    }
}

function closeManualCopyModal() {
    elements.manualCopyModal.classList.remove('active');
}

// åˆå§‹åŒ–åº”ç”¨
function initApp() {
    renderChaptersList();
    loadChapter(state.currentChapterId);
    updateWordCount();
    setupTabSwitching();
    setupEventListeners();
    
    if (state.isDarkTheme) {
        document.body.classList.add('dark-theme');
        elements.themeToggle.textContent = 'â˜€ï¸ æµ…è‰²æ¨¡å¼';
    }
    
    setInterval(saveCurrentChapter, 3000);
    setInterval(autoSaveVersion, 60000);

    SecondEditor.init();
    FullTextCopy.init();
    
    console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
}

// å¯åŠ¨åº”ç”¨
document.addEventListener('DOMContentLoaded', function() {
    initApp();
    SecondEditor.updateMaterialStats();
});
// åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ è¿™ä¸ªå¯åŠ¨ä»£ç 

// å…¶ä»–åŸæœ‰å‡½æ•°ä¿æŒä¸å˜ï¼ˆsetupTabSwitching, setupEventListeners, renderChaptersList, loadChapter, saveCurrentChapterç­‰ï¼‰
// ... [è¿™é‡ŒåŒ…å«ä¹‹å‰çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•°]
    </script>
</body>
    </body>
</html>